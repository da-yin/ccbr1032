---
title: "ccbr1032"
author: "Da"
date: "3/27/2020"
output: html_document
---

RNA-seq data analysis - human glioblastoma treatment using LMP400 and Olaparib
=======================

Data source
-----------
Jing Wu Lab at NIH.
44 patient-derived human glioblastoma mRNA samples sequenced at Sequencing Facility on NextSeq using Illumina TruSeq Stranded mRNA Library Prep and paired-end sequencing.


Folder structure
-----------

```
.
├── rawData                  # raw data
|   ├── RawCountFile         # raw count file from Sequencing Facility
|   ├── sample info          # sample metadata table from Madison Butler
│   ├── filteredCounts       # filtered gene counts generated using EdgeR filterByExpr 
│       ├── filtered         # keeps genes that have a CPM of 0.2 or more in at least three samples
|       ├── sampletable      # sampletable.txt has metadata including sampleName, fileName, condition and label.
├── analysis                 # analysis folder that contains script and results
│   ├── processedData        # Intermediate text result files
|       ├── DEGs             # Gene differential expression generated using Limma Voom. 
|       ├── normalized       # Voom quantile normalized, batch-corrected counts
|       ├── IPA              # DEG gene IDs, FC, P value tables, input for IPA
|       ├── ORA_GSEA         # Gene Set Enrichment Analysis using GO BP, KEGG, Reactome gene sets database
|           ├──.*csv         # significant pathways(Padjust < 0.05) and the genes involved in these pathways
|           ├──.*pdf         # dotplot of top 10 significant pathways
│   ├── results              # various plots                    
|       ├── glimma-plots     # Interactive differential expression gene plot
|       ├── PCA              # PCA plot for each contrast generated using normalized, batch-corrected counts
|       ├── heatmap          # DEGs for each contrast
|       ├── venn             # overlap of DEGs for each drug treatment
|       ├── volcano          # visualizing significant DEGs, log2 > 1 or < -1; -log10FDR > 1.3 (FDR<0.05)
|       ├── pathview         # visualizing significant DEGs in a KEGG pathway
│   ├── *.Rmd                # R scripts 
│   ├── *.html               # Rmarkdown html knit file
├── reports                  # Powerpoing presentation, MultiQC report from SF
├── ref                      # methods and references
├── readme.md                # analysis objectives and summary                       
└── ...
```



Objectives
--------

- Generate differential expression using Limma Voom.
- Perform over-representation analysis(ORA) and Gene Set Enrichment Analysis (GSEA) using Clusterprofiler.
- Difference in response between GSC cells vs. SF cells
- What response/results are consistent in both GSC923 and GSC827
- Investigate the genes and pathways regulated by drug combinations.
- identify potential genes/pathways that drive Tivozanib resistance.


---

Summary
--------

Our goal is to use RNA sequencing to investigate the expression changes in pathways such as DNA damage, DNA repair, cell cycle signaling, and apoptosis after treatment with a drug combination. We are using established and patient-derived human glioblastoma (brain tumor) cell lines, and treating with a drug combination that induces DNA damage, cell cycle arrest, and apoptosis. Additionally, RNA-Seq would also allow us to observe expression changes in additional pathways which could lead to identification of novel mechanisms of drug action, which we are interested in as well.

Cell lines:

- GSC923
- GSC827
- SF10417
- SF10602


Contrast:

- treated-Ctrl(Olaparib, LMP400, LMP400+Olaparib Vs. Control): GSC923(GSC827, SF10417, SF10602)
- Ola – Ctrl(Olaparib Vs. Control): GSC923(GSC827, SF10417, SF10602)
- LMP – Ctrl(LMP400 Vs. Control): GSC923(GSC827, SF10417, SF10602)
- LMP.Olap - Ctrl(LMP400+Olaparib Vs. Control): GSC923(GSC827, SF10417, SF10602)
- LMP.Olap – Ola(LMP400+Olaparib Vs. Olaparib): GSC923(GSC827, SF10417, SF10602)
- LMP.Olap – LMP(LMP400+Olaparib Vs. LMP400): GSC923(GSC827, SF10417, SF10602)


The Limma package was used to test for differential gene expression between experimental conditions. Batch ID
was added as a covariate in the linear modeling.Significant differentially expressed genes were identified with a false-discovery rate ≤ 0.05 and a log(fold change) > 1. 

DEGs:

- LMP_417-Ctrl_417 : 0
- LMP_602-Ctrl_602 : 41
- LMP_827-Ctrl_827 : 0
- LMP_923-Ctrl_923 : 38
- LMP.Olap_417-Ctrl_417 : 0
- LMP.Olap_417-LMP_417 : 0
- LMP.Olap_417-Ola_417 : 0
- LMP.Olap_602-Ctrl_602 : 88
- LMP.Olap_602-LMP_602 : 23
- LMP.Olap_602-Ola_602 : 82
- LMP.Olap_827-Ctrl_827 : 0
- LMP.Olap_827-LMP_827 : 0
- LMP.Olap_827-Ola_827 : 41
- LMP.Olap_923-Ctrl_923 : 415
- LMP.Olap_923-LMP_923 : 68
- LMP.Olap_923-Ola_923 : 222
- Ola_417-Ctrl_417 : 0
- Ola_602-Ctrl_602 : 15
- Ola_827-Ctrl_827 : 0
- Ola_923-Ctrl_923 : 1
- treated_417-Ctrl_417 : 0
- treated_602-Ctrl_602 : 1
- treated_827-Ctrl_827 : 0
- treated_923-Ctrl_923 : 0

Pathway enrichment was performed using pre-ranked Gene Set Enrichment Analysis (GSEA) with the KEGG, Reactome and BP genesets from the Molecular Signatures Database. 

For GSEA, the genes for each contrast are ordered in a ranked list based on gsea_ranking_score, -log10(pvalue)*sign(log2fc). GSEA analysis reveals significant inhibition or up-regulation of gene sets. On the x-axis, the genes are ranked from the most up-regulated (left end) to the most down-regulated (right end). The “barcode” indicates the position of the genes from the biological pathway. The y-axis shows a running enrichment score (ES), which goes up when genes are encountered in the pathway and goes down otherwise—leading to an assessment of the distribution within the set of all genes. ES reflects the degree to which a set S(e.g Apoptosis) is overrepresented at the extremes.The normalized enrichment score (NES) is inferred from permutations of the gene set and the false discovery rate (FDR). NES is normalized enrichment score which account for the size of the set. Negative NES means the down-regulation and positve value means up-regulation. (ref Subramanian et al. PNAS 2005) 


IPA was performed and anaysis results shared with collaborator using their Email addresses.


CCBR contact
--------
Da Yin: yind3@nih.gov


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
suppressMessages(library('edgeR'))
suppressMessages(library('statmod'))
suppressMessages(library(gplots))
suppressMessages(library('reshape'))
suppressMessages(library('limma'))
suppressMessages(library('geneplotter'))
suppressMessages(library(filesstrings))
suppressMessages(library(ff))
suppressMessages(library(Glimma))
suppressMessages(library(dplyr))
suppressMessages(library(RColorBrewer))
suppressMessages(library(pheatmap))
suppressMessages(library(clusterProfiler))
suppressMessages(library(argparse))
suppressMessages(library(org.Hs.eg.db))
suppressMessages(library(org.Mm.eg.db))
suppressMessages(library(ReactomePA))
suppressMessages(library(ggplot2))
suppressMessages(library(EnhancedVolcano))
suppressMessages(library(ggfortify))
suppressMessages(library(ggrepel))
suppressMessages(library(VennDiagram))
suppressMessages(library(biomaRt))
suppressMessages(library(enrichplot))
suppressMessages(library(gridExtra))
suppressMessages(library(gplots))
library("factoextra")
library(DescTools)
library(DT)

theme_set(theme_classic())
```

```{r}
setwd("~/Desktop/active_projects/ccbr1032/analysis/")
analysis_dir = "~/Desktop/active_projects/ccbr1032/analysis/"
results_dir = "~/Desktop/active_projects/ccbr1032/analysis/results/"
DEGs_dir = "~/Desktop/active_projects/ccbr1032/analysis/processedData/DEGs/"
normalized_data_dir = "~/Desktop/active_projects/ccbr1032/analysis/processedData/normalized/"
path_out = "~/Desktop/active_projects/ccbr1032/analysis/processedData/ORA_GSEA/"

writeFile = function(data, name){
  fileName = paste(path_out, name, sep='')
  write.csv(data, fileName)
}
```

```{r}
rawCount
```


```{r}
rawCount =read.table("~/Desktop/active_projects/ccbr1032/rawData/RawCountFile_rsemgenes.txt", header = T, stringsAsFactors = F)

rawCount$gene_id = gsub("_", "|", rawCount$gene_id)
rownames(rawCount) = rawCount$gene_id

#colnames(rawCount) = gsub("X", "", colnames(rawCount))
colnames(rawCount) = gsub("*._923", "GSC923", colnames(rawCount))
colnames(rawCount) = gsub("*._827", "GSC827", colnames(rawCount))
colnames(rawCount) = gsub("*._417", "SF417", colnames(rawCount))
colnames(rawCount) = gsub("*._602", "SF602", colnames(rawCount))
colnames(rawCount) = gsub("X", "", colnames(rawCount))
colnames(rawCount) = gsub("X1", "", colnames(rawCount))
colnames(rawCount) = gsub("X2", "", colnames(rawCount))
colnames(rawCount) = gsub("X3", "", colnames(rawCount))
colnames(rawCount) = gsub("*.GSC", "GSC", colnames(rawCount))
colnames(rawCount) = gsub("*.SF", "SF", colnames(rawCount))
colnames(rawCount) = gsub("RP1", "R1", colnames(rawCount))
colnames(rawCount) = gsub("RP2", "R2", colnames(rawCount))
colnames(rawCount) = gsub("RP3", "R3", colnames(rawCount))

# reverse cell line and drug
colnames(rawCount) = gsub("GSC923_C", "Ctrl_923", colnames(rawCount))
colnames(rawCount) = gsub("GSC923_LO", "LMP.Olap_923", colnames(rawCount))
colnames(rawCount) = gsub("GSC923_L", "LMP_923", colnames(rawCount))
colnames(rawCount) = gsub("GSC923_O", "Ola_923", colnames(rawCount))

#set batch
colnames(rawCount) = gsub("923_R2","923_R2B1", colnames(rawCount))
colnames(rawCount) = gsub("923_R3","923_R3B1", colnames(rawCount))
colnames(rawCount) = gsub("923_R4","923_R1B2", colnames(rawCount))


colnames(rawCount) = gsub("GSC827_C", "Ctrl_827", colnames(rawCount))
colnames(rawCount) = gsub("GSC827_LO", "LMP.Olap_827", colnames(rawCount))
colnames(rawCount) = gsub("GSC827_L", "LMP_827", colnames(rawCount))
colnames(rawCount) = gsub("GSC827_O", "Ola_827", colnames(rawCount))

colnames(rawCount) = gsub("827_R1","827_R1B1", colnames(rawCount))
colnames(rawCount) = gsub("827_R2","827_R2B1", colnames(rawCount))
colnames(rawCount) = gsub("827_R3","827_R3B2", colnames(rawCount))



colnames(rawCount) = gsub("SF417_C", "Ctrl_417", colnames(rawCount))
colnames(rawCount) = gsub("SF417_LO", "LMP.Olap_417", colnames(rawCount))
colnames(rawCount) = gsub("SF417_L", "LMP_417", colnames(rawCount))
colnames(rawCount) = gsub("SF417_O", "Ola_417", colnames(rawCount))

colnames(rawCount) = gsub("417_R1","417_R1B1", colnames(rawCount))
colnames(rawCount) = gsub("417_R2","417_R2B2", colnames(rawCount))
colnames(rawCount) = gsub("417_R3","417_R3B2", colnames(rawCount))



colnames(rawCount) = gsub("SF602_C", "Ctrl_602", colnames(rawCount))
colnames(rawCount) = gsub("SF602_LO", "LMP.Olap_602", colnames(rawCount))
colnames(rawCount) = gsub("SF602_L", "LMP_602", colnames(rawCount))
colnames(rawCount) = gsub("SF602_O", "Ola_602", colnames(rawCount))

colnames(rawCount) = gsub("602_R1","602_R1B1", colnames(rawCount))
colnames(rawCount) = gsub("602_R2","602_R2B2", colnames(rawCount))

# extract the samples from each cell line
GSC923_raw = rawCount[,which(colnames(rawCount)%like%c("%923%"))]
GSC827_raw = rawCount[,which(colnames(rawCount)%like%c("%827%"))]
SF417_raw = rawCount[,which(colnames(rawCount)%like%c("%417%"))]
SF602_raw = rawCount[,which(colnames(rawCount)%like%c("%602%"))]

#
dir.create("../rawData/filteredCounts/RawCountFile_rsemgenes")

# GSC923
dir.create("../rawData/filteredCounts/GSC923_Treated_Ctrl")
dir.create("../rawData/filteredCounts/GSC923_LMP_Ctrl")
dir.create("../rawData/filteredCounts/GSC923_Ola_Ctrl")
dir.create("../rawData/filteredCounts/GSC923_LMP.Olap_Ctrl")
dir.create("../rawData/filteredCounts/GSC923_LMP.Olap_LMP")
dir.create("../rawData/filteredCounts/GSC923_LMP.Olap_Ola")

# GSC827
dir.create("../rawData/filteredCounts/GSC827_Treated_Ctrl")
dir.create("../rawData/filteredCounts/GSC827_LMP_Ctrl")
dir.create("../rawData/filteredCounts/GSC827_Ola_Ctrl")
dir.create("../rawData/filteredCounts/GSC827_LMP.Olap_Ctrl")
dir.create("../rawData/filteredCounts/GSC827_LMP.Olap_LMP")
dir.create("../rawData/filteredCounts/GSC827_LMP.Olap_Ola")

# SF417
dir.create("../rawData/filteredCounts/SF417_Treated_Ctrl")
dir.create("../rawData/filteredCounts/SF417_LMP_Ctrl")
dir.create("../rawData/filteredCounts/SF417_Ola_Ctrl")
dir.create("../rawData/filteredCounts/SF417_LMP.Olap_Ctrl")
dir.create("../rawData/filteredCounts/SF417_LMP.Olap_LMP")
dir.create("../rawData/filteredCounts/SF417_LMP.Olap_Ola")

# SF602
dir.create("../rawData/filteredCounts/SF602_Treated_Ctrl")
dir.create("../rawData/filteredCounts/SF602_LMP_Ctrl")
dir.create("../rawData/filteredCounts/SF602_Ola_Ctrl")
dir.create("../rawData/filteredCounts/SF602_LMP.Olap_Ctrl")
dir.create("../rawData/filteredCounts/SF602_LMP.Olap_LMP")
dir.create("../rawData/filteredCounts/SF602_LMP.Olap_Ola")


```

# manually entered the conditions for each of the treated-control
```{r}
GSC923_keep.exprs = filterByExpr(GSC923_raw, group = colnames(GSC923_raw))
GSC923_filterd = GSC923_raw[GSC923_keep.exprs,]
GSC923_sampleTable = data.frame(sampleName = colnames(GSC923_filterd), fileName=colnames(GSC923_filterd),
                                condition= c("Ctrl_923","treated_923","treated_923","treated_923","Ctrl_923",                                                                            "treated_923","treated_923","treated_923","Ctrl_923","treated_923",
                                             "treated_923","treated_923"), label=colnames(GSC923_filterd), batch=gsub(".*B","", colnames(GSC923_filterd)))
write.table(GSC923_filterd, "../rawData/filteredCounts/GSC923_Treated_Ctrl/filtered.txt", quote = F, sep = "\t")
write.table(GSC923_sampleTable, "../rawData/filteredCounts/GSC923_Treated_Ctrl/sampletable.txt", quote = F, sep = "\t", row.names = F )


GSC827_keep.exprs = filterByExpr(GSC827_raw, group = colnames(GSC827_raw))
GSC827_filterd = GSC827_raw[GSC827_keep.exprs,]
GSC827_sampleTable = data.frame(sampleName = colnames(GSC827_filterd), fileName=colnames(GSC827_filterd),
                                condition= c("Ctrl_827","treated_827","treated_827","treated_827","Ctrl_827",                                                                            "treated_827","treated_827","treated_827","Ctrl_827","treated_827",
                                             "treated_827","treated_827"), label=colnames(GSC827_filterd), batch=gsub(".*B","", colnames(GSC827_filterd)))
write.table(GSC827_filterd, "../rawData/filteredCounts/GSC827_Treated_Ctrl/filtered.txt", quote = F, sep = "\t")
write.table(GSC827_sampleTable, "../rawData/filteredCounts/GSC827_Treated_Ctrl/sampletable.txt", quote = F, sep = "\t", row.names = F )


SF417_keep.exprs = filterByExpr(SF417_raw, group = colnames(SF417_raw))
SF417_filterd = SF417_raw[SF417_keep.exprs,]
SF417_sampleTable = data.frame(sampleName = colnames(SF417_filterd), fileName=colnames(SF417_filterd),
                                condition= c("Ctrl_417","treated_417","treated_417","treated_417","Ctrl_417",                                                                            "treated_417","treated_417","treated_417","Ctrl_417","treated_417",
                                             "treated_417","treated_417"), label=colnames(SF417_filterd), batch=gsub(".*B","", colnames(SF417_filterd)))
write.table(SF417_filterd, "../rawData/filteredCounts/SF417_Treated_Ctrl/filtered.txt", quote = F, sep = "\t")
write.table(SF417_sampleTable, "../rawData/filteredCounts/SF417_Treated_Ctrl/sampletable.txt", quote = F, sep = "\t", row.names = F )

SF602_keep.exprs = filterByExpr(SF602_raw, group = colnames(SF602_raw))
SF602_filterd = SF602_raw[SF602_keep.exprs,]
colnames(SF602_filterd)
SF602_sampleTable = data.frame(sampleName = colnames(SF602_filterd), fileName=colnames(SF602_filterd),
                                condition= c("Ctrl_602","treated_602","treated_602","treated_602","Ctrl_602",                                                                            "treated_602","treated_602","treated_602"), label=colnames(SF602_filterd), batch=gsub(".*B","", colnames(SF602_filterd)))
write.table(SF602_filterd, "../rawData/filteredCounts/SF602_Treated_Ctrl/filtered.txt", quote = F, sep = "\t")
write.table(SF602_sampleTable, "../rawData/filteredCounts/SF602_Treated_Ctrl/sampletable.txt", quote = F, sep = "\t", row.names = F )


rawCount_keep.exprs = filterByExpr(rawCount[,2:ncol(rawCount)], group = colnames(rawCount))
rawCount_filtered = rawCount[rawCount_keep.exprs,]
rawCount_filtered$gene_id=NULL
colnames(rawCount_filtered)
rawCount_sampleTable = data.frame(sampleName = colnames(rawCount_filtered), fileName=colnames(rawCount_filtered),
                                  condition=ifelse(colnames(rawCount_filtered)%like%"Ctrl%", "Ctrl", "treated"),
                                  label=colnames(rawCount_filtered), batch=gsub(".*B","", colnames(rawCount_filtered)))

write.table(rawCount_filtered, "../rawData/filteredCounts/RawCountFile_rsemgenes/filtered.txt", quote = F, sep = "\t")
write.table(rawCount_sampleTable, "../rawData/filteredCounts/RawCountFile_rsemgenes/sampletable.txt", quote = F, sep = "\t", row.names = F )
```


```{r}
myGetSamples = function(cell.raw, groupA, groupB, dir){
  samples = cell.raw[which(colnames(cell.raw)%like%c(groupA, groupB))]
  samples.group = gsub("\\_.*","",colnames(samples))
  samples.keepGenes = filterByExpr(data.matrix(samples), group = samples.group)
  samples_filtered = samples[samples.keepGenes,]
  sampleTable = data.frame(sampleName = colnames(samples), fileName=colnames(samples), 
                           condition=gsub("\\_R.*","", colnames(samples)), label = colnames(samples), batch=gsub(".*B","", colnames(samples)))
  
  write.table(samples_filtered, paste0("../rawData/filteredCounts/", dir, "/filtered.txt"), quote = F, sep = "\t")
  write.table(sampleTable, paste0("../rawData/filteredCounts/", dir, "/sampletable.txt"), quote = F, sep = "\t")
}

# GSC923
myGetSamples(cell.raw = GSC923_raw, groupA = "%Ola_%", groupB = "%Ctrl_%", dir = "GSC923_Ola_Ctrl")
myGetSamples(cell.raw = GSC923_raw, groupA = "%LMP_%", groupB = "%Ctrl_%", dir = "GSC923_LMP_Ctrl")
myGetSamples(cell.raw = GSC923_raw, groupA = "%LMP.Olap_%", groupB = "%Ctrl_%", dir = "GSC923_LMP.Olap_Ctrl")
myGetSamples(cell.raw = GSC923_raw, groupA = "%LMP.Olap_%", groupB = "%Ola_%", dir = "GSC923_LMP.Olap_Ola")
myGetSamples(cell.raw = GSC923_raw, groupA = "%LMP.Olap_%", groupB = "%LMP_%", dir = "GSC923_LMP.Olap_LMP")

# GSC827
myGetSamples(cell.raw = GSC827_raw, groupA = "%Ola_%", groupB = "%Ctrl_%", dir = "GSC827_Ola_Ctrl")
myGetSamples(cell.raw = GSC827_raw, groupA = "%LMP_%", groupB = "%Ctrl_%", dir = "GSC827_LMP_Ctrl")
myGetSamples(cell.raw = GSC827_raw, groupA = "%LMP.Olap_%", groupB = "%Ctrl_%", dir = "GSC827_LMP.Olap_Ctrl")
myGetSamples(cell.raw = GSC827_raw, groupA = "%LMP.Olap_%", groupB = "%Ola_%", dir = "GSC827_LMP.Olap_Ola")
myGetSamples(cell.raw = GSC827_raw, groupA = "%LMP.Olap_%", groupB = "%LMP_%", dir = "GSC827_LMP.Olap_LMP")

# SF417
myGetSamples(cell.raw = SF417_raw, groupA = "%Ola_%", groupB = "%Ctrl_%", dir = "SF417_Ola_Ctrl")
myGetSamples(cell.raw = SF417_raw, groupA = "%LMP_%", groupB = "%Ctrl_%", dir = "SF417_LMP_Ctrl")
myGetSamples(cell.raw = SF417_raw, groupA = "%LMP.Olap_%", groupB = "%Ctrl_%", dir = "SF417_LMP.Olap_Ctrl")
myGetSamples(cell.raw = SF417_raw, groupA = "%LMP.Olap_%", groupB = "%Ola_%", dir = "SF417_LMP.Olap_Ola")
myGetSamples(cell.raw = SF417_raw, groupA = "%LMP.Olap_%", groupB = "%LMP_%", dir = "SF417_LMP.Olap_LMP")

# SF602
myGetSamples(cell.raw = SF602_raw, groupA = "%Ola_%", groupB = "%Ctrl_%", dir = "SF602_Ola_Ctrl")
myGetSamples(cell.raw = SF602_raw, groupA = "%LMP_%", groupB = "%Ctrl_%", dir = "SF602_LMP_Ctrl")
myGetSamples(cell.raw = SF602_raw, groupA = "%LMP.Olap_%", groupB = "%Ctrl_%", dir = "SF602_LMP.Olap_Ctrl")
myGetSamples(cell.raw = SF602_raw, groupA = "%LMP.Olap_%", groupB = "%Ola_%", dir = "SF602_LMP.Olap_Ola")
myGetSamples(cell.raw = SF602_raw, groupA = "%LMP.Olap_%", groupB = "%LMP_%", dir = "SF602_LMP.Olap_LMP")


```


#### heatmap for Top 500 most variable genes across samples
```{r heatmap for Top 500 most variable genes}
var_genes  = apply(GSC923_filterd_normalized, 1, var)
select_var <- names(sort(var_genes, decreasing=TRUE))[1:500]
select_var_count = GSC923_filterd_normalized[select_var,]

mypalette <- brewer.pal(11,"RdYlBu")
morecols <- colorRampPalette(mypalette)

ComplexHeatmap::Heatmap(matrix = t(scale(t(data.matrix(select_var_count)))), name="Z-score", km=1, 
                        col=colorRampPalette(rev(brewer.pal(n = 7, name ="RdYlBu")))(100), row_names_gp = gpar(fontsize = 0.9, fontface = "bold"),
                        column_names_gp = gpar(fontsize = 12, fontface = "bold"),
                        cluster_columns = T, column_title = "cluster", column_title_gp = gpar(fontsize = 15, fontface = "bold"), 
                        column_title_side = "bottom", column_names_rot = 60)
```



### limma voom for differential expression
```{r use limma voom to compute differential expression, message=FALSE, warning=FALSE, include=FALSE}
limmaDEG = function(DIR,FILE1,FILE2, CONTRASTS){
  
  sampleinfo=read.delim(FILE1)
  x = read.delim(FILE2,row.names=1)
   colnames(x)=as.character(sampleinfo[,4])
  
  myconditions = as.factor(sampleinfo$condition)
  dge_before = DGEList(counts=x,group=myconditions)
  dge_before <- calcNormFactors(dge_before,method="TMM")
  
  Group <- factor(sampleinfo$condition)
  Batch <- factor(sampleinfo$batch)
  design=model.matrix(~0+Group+Batch)
  design2=model.matrix(~0+Group)
  contras=unlist(strsplit(CONTRASTS, split=" "))  
  cons=c()
  for(i in seq(1, length(contras), by = 2))
  {{
    cons=c(cons,paste(contras[i],"-",contras[i+1],sep=""))
  }}
  
  v1 <- voom(as.matrix(x),design,plot=F,normalize="quantile")
  
  sf = v1$E/log2((x/colSums(x))*1000000)
  rn=rownames(v1$E)
  ensID=apply(array(as.character(rn)),1,function(z) unlist(strsplit(z, "\\|"))[1])
  gene=apply(array(as.character(rn)),1,function(z) unlist(strsplit(z, "\\|"))[2])
  mydata=cbind(ensID,gene,v1$E)
  
  sf=cbind(ensID,gene,sf)
  nb=length(contras)/2
# colnames(design) <- levels(Group)
  colnames(design) <- gsub("Group", "", colnames(design))
  fit <- lmFit(v1,design)
  contrast.matrix <- makeContrasts(contrasts=cons,levels=design)
  fitb <- contrasts.fit(fit, contrast.matrix)
  ebayes.fit=eBayes(fitb)
  dt = decideTests(ebayes.fit)
  glMDPlot(ebayes.fit, status=dt, counts=v1, groups=Group, side.main="Symbols")
  
  nor_batchCor = removeBatchEffect(x = v1$E, batch = Batch,design = design2)
  
  write.table(nor_batchCor,file=paste("limma_Voom_normalized_",cons[i],"_data.txt",sep=""),
              row.names=TRUE,col.names=NA,sep="\t",quote=FALSE)
  
  edf=as.matrix(nor_batchCor)
  tedf= t(edf)
  tedf=tedf[,apply(tedf,2,var)!= 0]
  pca=prcomp(tedf)
  tedf1 = data.frame(tedf)
  Phenotype=sampleinfo$condition
  cell_rep=sampleinfo$label
  tedf1$group = as.factor(Phenotype)

  pca.plot = autoplot(object = pca, data=tedf1, colour="group",
                      repel = TRUE, label.size = 3,label.repel=T)
  
  ggsave(filename = paste("results/","PCA_",cons[i],".pdf",sep=""),plot = pca.plot)
  
  all.genes.con = topTable(ebayes.fit, coef = i, number=nrow(ebayes.fit), sort.by="none")

  all.genes.con$FC <- ifelse(all.genes.con$logFC<0, -1/(2^all.genes.con$logFC), 2^all.genes.con$logFC)
  final=all.genes.con
  # 
  x=rownames(all.genes.con)
  ensID=apply(array(as.character(x)),1,function(z) unlist(strsplit(z, "\\|"))[1])
  gene=apply(array(as.character(x)),1,function(z) unlist(strsplit(z, "\\|"))[2])
  all.genes.con=cbind(ensID,gene,all.genes.con)
  write.table(all.genes.con,file=paste("limma_DEG_",cons[i],"_all_genes.txt",sep=""),
              sep="\t",col.names=NA)

  # 
  # #Reformatted DEG File
  limmaout=read.table(paste("limma_DEG_",cons[i],"_all_genes.txt",sep=""), header = TRUE)
  limmaout=limmaout[,which(names(limmaout) %in% c("X","gene","logFC","P.Value"))]
  limmaout$fc=2^limmaout$logFC
  down_reg=limmaout$logFC<0
  limmaout$fc[down_reg]=-1/limmaout$fc[down_reg]
  limmaout=limmaout[,c("X","gene","fc","logFC","P.Value")]
  colnames(limmaout)=c("ensid_gene","gene","fc","log2fc","pvalue")
  limmaout$fdr=p.adjust(limmaout$pvalue,method='fdr',n=length(limmaout$pvalue))
  limmaout$gsea_ranking_score=-log10(limmaout$pvalue)*sign(limmaout$log2fc)
  write.table(limmaout,file=paste("limma_DEG_",cons[i],"_all_genes.txt",sep=""),row.names=FALSE,col.names=TRUE,quote=FALSE,sep="\t")
  # 
  file.rename(from = list.files(pattern = "glimma-plots"), to = paste0("glimma-plots_",cons[i],sep=""))
  path1 = paste0(analysis_dir, paste("glimma-plots_",cons[i],sep=""))
  path2 = paste0(results_dir, paste("glimma-plots_",cons[i],sep=""))
  file.move(path1, path2)
  file.move(list.files(pattern = "DEG"), DEGs_dir)
  file.move(list.files(pattern = "limma_Voom_normalized"), normalized_data_dir)
}
```

```{r}
limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/RawCountFile_rsemgenes/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/RawCountFile_rsemgenes/filtered.txt",
         CONTRASTS="treated Ctrl")
```


# GSC923 
```{r}
limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC923_Treated_Ctrl/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC923_Treated_Ctrl/filtered.txt",
         CONTRASTS="treated_923 Ctrl_923")

limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC923_Ola_Ctrl/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC923_Ola_Ctrl/filtered.txt",
         CONTRASTS="Ola_923 Ctrl_923")

limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC923_LMP_Ctrl/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC923_LMP_Ctrl/filtered.txt",
         CONTRASTS="LMP_923 Ctrl_923")

limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC923_LMP.Olap_Ctrl/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC923_LMP.Olap_Ctrl/filtered.txt",
         CONTRASTS="LMP.Olap_923 Ctrl_923")

limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC923_LMP.Olap_Ola/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC923_LMP.Olap_Ola/filtered.txt",
         CONTRASTS="LMP.Olap_923 Ola_923")

limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC923_LMP.Olap_LMP/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC923_LMP.Olap_LMP/filtered.txt",
         CONTRASTS="LMP.Olap_923 LMP_923")


```


# GSC827 cell line DE
```{r}
limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC827_Treated_Ctrl/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC827_Treated_Ctrl/filtered.txt",
         CONTRASTS="treated_827 Ctrl_827")

limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC827_Ola_Ctrl/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC827_Ola_Ctrl/filtered.txt",
         CONTRASTS="Ola_827 Ctrl_827")

limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC827_LMP_Ctrl/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC827_LMP_Ctrl/filtered.txt",
         CONTRASTS="LMP_827 Ctrl_827")

limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC827_LMP.Olap_Ctrl/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC827_LMP.Olap_Ctrl/filtered.txt",
         CONTRASTS="LMP.Olap_827 Ctrl_827")

limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC827_LMP.Olap_Ola/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC827_LMP.Olap_Ola/filtered.txt",
         CONTRASTS="LMP.Olap_827 Ola_827")

limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC827_LMP.Olap_LMP/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/GSC827_LMP.Olap_LMP/filtered.txt",
         CONTRASTS="LMP.Olap_827 LMP_827")
```

# SF417 cell line DE
```{r}
limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF417_Treated_Ctrl/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF417_Treated_Ctrl/filtered.txt",
         CONTRASTS="treated_417 Ctrl_417")

limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF417_Ola_Ctrl/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF417_Ola_Ctrl/filtered.txt",
         CONTRASTS="Ola_417 Ctrl_417")

limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF417_LMP_Ctrl/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF417_LMP_Ctrl/filtered.txt",
         CONTRASTS="LMP_417 Ctrl_417")

limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF417_LMP.Olap_Ctrl/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF417_LMP.Olap_Ctrl/filtered.txt",
         CONTRASTS="LMP.Olap_417 Ctrl_417")

limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF417_LMP.Olap_Ola/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF417_LMP.Olap_Ola/filtered.txt",
         CONTRASTS="LMP.Olap_417 Ola_417")

limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF417_LMP.Olap_LMP/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF417_LMP.Olap_LMP/filtered.txt",
         CONTRASTS="LMP.Olap_417 LMP_417")
```

# SF602 cell line DE
```{r}
limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF602_Treated_Ctrl/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF602_Treated_Ctrl/filtered.txt",
         CONTRASTS="treated_602 Ctrl_602")

limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF602_Ola_Ctrl/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF602_Ola_Ctrl/filtered.txt",
         CONTRASTS="Ola_602 Ctrl_602")

limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF602_LMP_Ctrl/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF602_LMP_Ctrl/filtered.txt",
         CONTRASTS="LMP_602 Ctrl_602")

limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF602_LMP.Olap_Ctrl/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF602_LMP.Olap_Ctrl/filtered.txt",
         CONTRASTS="LMP.Olap_602 Ctrl_602")

limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF602_LMP.Olap_Ola/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF602_LMP.Olap_Ola/filtered.txt",
         CONTRASTS="LMP.Olap_602 Ola_602")

limmaDEG(DIR=analysis_dir,
         FILE1="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF602_LMP.Olap_LMP/sampletable.txt",
         FILE2="~/Desktop/active_projects/ccbr1032/rawData/filteredCounts/SF602_LMP.Olap_LMP/filtered.txt",
         CONTRASTS="LMP.Olap_602 LMP_602")
```



#### read in the matrices into a list and modify the names
```{r read data}
my_files = list.files(path = DEGs_dir)
my_degs <- list()
for (i in my_files){
  print(i)
  my_degs[[i]] <- read.table(paste(DEGs_dir,i,sep = "/"),header = TRUE,sep='\t')
  my_degs[[i]]$ensid_gene <- gsub('\\..*','', my_degs[[i]]$ensid_gene)
}
names(my_degs) <- stringr::str_replace(my_files, pattern = "_all_genes.txt", replacement = "") %>% 
  stringr::str_replace(pattern = "limma_DEG_", replacement = "")

```


#### rank genes based on gsea_ranking_score, for GO gsea
```{r calculate degs; rank genes based on gsea_ranking_score, message=FALSE, warning=FALSE}
my_sig_degs = lapply(my_degs, function(x) subset(x, fdr < 0.05 & abs(fc) > 2))

my_degs_rankingScoresList <- lapply(my_degs, function(x){
  scores <- x$gsea_ranking_score
  names(scores) <- as.character(x$ensid_gene)
  scores <- sort(scores, decreasing = T)
})

```

#### Mapping DEGs to entrez IDs using ensemble, then symbol, then NCBI web scrapped IDs.  
```{r Converts EnsemblIDs to UNIPROTID; rank genes based on gsea_ranking_score, message=FALSE, warning=FALSE}

my_genes = data.frame()
for (x in my_degs) {
  temp_genes = x[, c("ensid_gene", "gene")]
  my_genes = dplyr::bind_rows(my_genes, temp_genes)
  my_genes = my_genes[!(duplicated(my_genes$ensid_gene)),]
}

Entrez_from_ensembl <- bitr(my_genes$ensid_gene, fromType = "ENSEMBL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)
colnames(Entrez_from_ensembl)[colnames(Entrez_from_ensembl)=="ENSEMBL"] <- "ensid_gene"
unmapped_ensid <- my_genes[!(my_genes$ensid_gene%in%Entrez_from_ensembl$ensid_gene),] 
unmapped_ensid <- unmapped_ensid[!duplicated(unmapped_ensid$gene),]
ensid_symbol.data <- bitr(unique(unmapped_ensid$gene), fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)
ensid_symbol.data <- ensid_symbol.data[!duplicated(ensid_symbol.data$SYMBOL),]
ensid_symbol_unmapped_ensid.data <- unmapped_ensid[(unmapped_ensid$gene%in%ensid_symbol.data$SYMBOL),]
Entrez_from_symbol = cbind(ensid_symbol_unmapped_ensid.data, ensid_symbol.data)
Entrez_from_symbol = Entrez_from_symbol[c("ensid_gene", "ENTREZID")]
Entrez_all <- dplyr::bind_rows(Entrez_from_ensembl, Entrez_from_symbol)
Entrez_unmapped = setdiff(my_genes$ensid_gene, Entrez_all$ensid_gene)

paste("Out of all", length(my_genes$ensid_gene), "DEGs:", length(Entrez_from_ensembl$ENTREZID), "were mapped to Entrez using Ensemble ID,", length(Entrez_from_symbol$ENTREZID), "mapped using gene symbol,", length(setdiff(my_genes$ensid_gene, Entrez_all$ensid_gene)), "cannot be mapped.")
```

#### rank genes based on gsea_ranking_score, for KEGG & Reactome gsea 
```{r ranking Entrez genes}
my_degs_entrez = lapply(my_degs, function(x){
  result <- merge(x, Entrez_all, by="ensid_gene") #adding a entrez column
})

my_sig_degs_entrez = lapply(my_degs_entrez, function(x) subset(x, fdr < 0.05 & abs(fc) > 2))

my_degs_entrez_rankingScoresList <- lapply(my_degs_entrez, function(x){
  scores <- x$gsea_ranking_score
  names(scores) <- as.character(x$ENTREZID)
  scores <- sort(scores, decreasing = T)
})
```

#### volcano plot for differentially expressed genes
```{r volcano plot DEGs}
myVolcanos = lapply(my_degs, function(x){
  EnhancedVolcano(x, 
                lab = x$gene,x = "log2fc", y = "fdr", ylab = bquote(~-Log[10]~FDR),FCcutoff = 1, 
                ylim= c(0, max(-log10(x$fdr), na.rm=TRUE) + 1),pCutoff = 0.05,
                legendPosition = 'top',titleLabSize = 22, subtitleLabSize = 20,
                captionLabSize= 18,
                pointSize = 0.8,labSize = 4.5,legendLabSize = 18,
                legendIconSize = 4,legend = c("NS","log2FC > |1|","FDR < 0.05",
                           "significant (FDR < 0.05) & log2FC > |1|")) 
})


volcanos = list()
for (i in 1:length(my_degs)){
  print(myVolcanos[[i]] + ggtitle(paste(names(myVolcanos[i]))))
  myVolcanos[[i]] + ggtitle(paste(names(myVolcanos[i])))
}

for (i in 1:length(my_degs)){
pdf(paste(results_dir, "volcano_", names(myVolcanos[i]), ".pdf", sep = ""), width = 11, height = 10)
print(myVolcanos[[i]] + ggtitle(paste(names(myVolcanos[i]))))
dev.off()
}


```

```{r}
for (i in 1: length(my_degs)){
  print(paste("Number of DEGS in",names(my_sig_degs[i]), ":", length(my_sig_degs[[i]]$gene), sep=" "))
}
```

```{r shortern labels for dotplots, include=FALSE}
#' Truncate string vector of ggplot axis label
#'
#' @param label    a ordered string vector
#' @param maxLen   max length of character (nchar) to show in label
#' @param maxWord  max count of words allowed to show in label
#' @param pattern  Word separater
#' @param dot      If true, three dots will added to truncated label
#'
#' @return a vector of truncated strings
#' @export
#'
#' @examples
short_label <- function(label, maxLen = 50, maxWord = 10, pattern = " ", dot = TRUE){
  l <- strsplit(label, pattern)
  short_label <- vector("character",length(l))
  
  for (i in seq_along(l)){
    truncated <- FALSE
    s <- l[[i]]
    if (length(s) > maxWord){
      ll <- paste(s[1:maxWord], collapse = " ")
      truncated <- TRUE
    }
    else{
      ll <- paste(s, collapse = " ")
    }
    
    if (nchar(ll) > maxLen){
      ll <- substr(ll, 1, maxLen)
      truncated <- TRUE
    }
    
    if (dot & truncated) ll <- paste(ll, "...",sep = " ")
    
    short_label[[i]] <- ll
  }
  attr(short_label, "pos") <- attr(label,"pos")
  return(short_label)
}
```

#### biological process gsea
```{r gsea biological process, message=FALSE, warning=FALSE}
myBP_gsea = lapply(my_degs_rankingScoresList, function(x){
  gseGO(geneList = x, OrgDb = org.Hs.eg.db, ont = "BP", nPerm = 30000, keyType = "ENSEMBL",
        minGSSize = 10, maxGSSize = 500, pvalueCutoff = 0.05, pAdjustMethod = "BH",
        verbose = TRUE)})

for (i in 1:length(myBP_gsea)){
  if (length(myBP_gsea[[i]]@result$ID)>0){
    dot.plot =
    dotplot(myBP_gsea[[i]], showCategory=10, split=".sign") + facet_grid(.~.sign)+ 
      ggtitle(paste(names(myBP_gsea[i]),"BP GSEA", sep = " ")) + 
      scale_y_discrete(label=short_label)
    #ggsave(filename = paste0("processedData/ORA_GSEA/", "myBP_gsea_", ,names(myBP_gsea[i]), ".pdf"),plot =  dot.plot,)
    pdf(file = paste0("processedData/ORA_GSEA/", "myBP_gsea_", names(myBP_gsea[i]), ".pdf"), width = 10)
    print(dot.plot)
    dev.off()
  }
}

for (i in 1:length(myBP_gsea)){
  myBP_gsea[[i]] = setReadable(myBP_gsea[[i]], 'org.Hs.eg.db', 'ENSEMBL')
  writeFile(myBP_gsea[[i]], paste0("myBP_gsea_",names(myBP_gsea[i]),".csv"))
}


myBP_gsea_LMP_Ctrl = myBP_gsea[c("LMP_417-Ctrl_417","LMP_923-Ctrl_923","LMP_827-Ctrl_827","LMP_602-Ctrl_602")]
myBP_gsea_OLA_Ctrl = myBP_gsea[c("Ola_417-Ctrl_417","Ola_923-Ctrl_923","Ola_827-Ctrl_827","Ola_602-Ctrl_602")]
myBP_gsea_LMP.Olap_Ctrl = myBP_gsea[c("LMP.Olap_417-Ctrl_417","LMP.Olap_923-Ctrl_923","LMP.Olap_827-Ctrl_827","LMP.Olap_602-Ctrl_602")]

myBP_gsea_LMP_Ctrl_all = c(myBP_gsea_LMP_Ctrl[[1]]@result$Description,myBP_gsea_LMP_Ctrl[[2]]@result$Description,                                      myBP_gsea_LMP_Ctrl[[3]]@result$Description,myBP_gsea_LMP_Ctrl[[4]]@result$Description)



unlist(myBP_gsea_LMP_Ctrl[[2]]@result$Description)

df1 = data.frame(table(myBP_gsea_LMP_Ctrl_all))
df1[order(df1$Freq, decreasing = F),]
df1[which(df1$Freq>1),]
datatable(myBP_gsea_LMP.Olap_Ctrl[[4]]@result)
myBP_gsea_LMP.Olap_Ctrl[3]

LMP_Ctrl_827_BP = c("mitotic G1 DNA damage checkpoint", "DNA damage response, signal transduction by p53 class mediator resulting in cell cycle arrest", "signal transduction involved in mitotic G1 DNA damage checkpoint","intracellular signal transduction involved in G1 DNA damage checkpoint", )

LMP_Ctrl_923_BP = c("intrinsic apoptotic signaling pathway in response to DNA damage","positive regulation of cell cycle","apoptotic signaling pathway", "cellular component disassembly involved in execution phase of apoptosis")

LMP.Olap_Ctrl_417_BP = c("intrinsic apoptotic signaling pathway in response to DNA damage","apoptotic signaling pathway")
LMP.Olap_Ctrl_602_BP = c("DNA damage checkpoint", "signal transduction in response to DNA damage","DNA repair")

LMP.Olap_Ctrl_827_BP = c("intrinsic apoptotic signaling pathway by p53 class mediator", "intrinsic apoptotic signaling pathway in response to DNA damage by p53 class mediator","regulation of cysteine-type endopeptidase activity involved in apoptotic process", "DNA damage response, signal transduction by p53 class mediator","mitotic DNA damage checkpoint", "signal transduction involved in mitotic DNA damage checkpoint")

LMP.Olap_Ctrl_923_BP = c("DNA repair", "apoptotic signaling pathway", "positive regulation of cell cycle")

LMP.Olap_Ctrl_827_BP_obj = myBP_gsea_LMP.Olap_Ctrl[[3]][which(myBP_gsea_LMP.Olap_Ctrl[[3]]@result$Description%in%LMP.Olap_Ctrl_827_BP),asis=T]
dotplot(LMP.Olap_Ctrl_827_BP_obj, split=".sign") + facet_grid(.~.sign)

LMP.Olap_Ctrl_827_DEGs = my_degs$`LMP.Olap_827-Ctrl_827`[-which(duplicated(my_degs$`LMP.Olap_827-Ctrl_827`$gene)),]

rownames(LMP.Olap_Ctrl_827_DEGs) = LMP.Olap_Ctrl_827_DEGs$gene
LMP.Olap_Ctrl_827_DEGs = LMP.Olap_Ctrl_827_DEGs %>% dplyr::select(fc) %>% data.matrix()
LMP.Olap_Ctrl_827_DEGs = unlist(LMP.Olap_Ctrl_827_DEGs[,1])

cnetplot(LMP.Olap_Ctrl_827_BP_obj, categorySize="pvalue", foldChange=LMP.Olap_Ctrl_827_DEGs)
emapplot(LMP.Olap_Ctrl_827_BP_obj )
gseaplot2(LMP.Olap_Ctrl_827_BP_obj, geneSetID = 1, title = LMP.Olap_Ctrl_827_BP_obj$Description[1])
gseaplot2(LMP.Olap_Ctrl_827_BP_obj, geneSetID = 1:length(LMP.Olap_Ctrl_827_BP_obj@result$Description))



countNor_LMP.Olap_Ctrl = countNor[which(colnames(countNor)%like%c("Ctrl_%","LMP.Olap_%"))]
countNor_LMP.Olap_Ctrl$gene = gsub(".*[|]","", rownames(countNor_LMP.Olap_Ctrl))

term = "intrinsic apoptotic signaling pathway in response to DNA damage by p53 class mediator"
intrinsic_apoptotic_gene = LMP.Olap_Ctrl_827_BP_obj[which(LMP.Olap_Ctrl_827_BP_obj$Description==term),c("core_enrichment")]
intrinsic_apoptotic_gene = strsplit(as.character(intrinsic_apoptotic_gene), '\\/') %>% unlist()
countNor_LMP.Olap_Ctrl_intrinsic_apoptotic = countNor_LMP.Olap_Ctrl[which(countNor_LMP.Olap_Ctrl$gene%in%intrinsic_apoptotic_gene),]
rownames(countNor_LMP.Olap_Ctrl_intrinsic_apoptotic) = countNor_LMP.Olap_Ctrl_intrinsic_apoptotic$gene
countNor_LMP.Olap_Ctrl_intrinsic_apoptotic$gene=NULL


ComplexHeatmap::Heatmap(matrix = t(scale(t(countNor_LMP.Olap_Ctrl_intrinsic_apoptotic))), 
                          name="Z-score", km=1, 
                        col=colorRampPalette(rev(brewer.pal(n = 7, name ="RdYlBu")))(100), 
                        row_names_gp = gpar(fontsize = ifelse(nrow(countNor_LMP.Olap_Ctrl_intrinsic_apoptotic) <= 30, 10, 
                                                       ifelse(30<nrow(countNor_LMP.Olap_Ctrl_intrinsic_apoptotic)&nrow(countNor_LMP.Olap_Ctrl_intrinsic_apoptotic) <= 45, 7,
                                                       ifelse(45<nrow(countNor_LMP.Olap_Ctrl_intrinsic_apoptotic)&nrow(countNor_LMP.Olap_Ctrl_intrinsic_apoptotic) <= 60, 5, 4))), fontface = "bold"),
                        column_names_gp = gpar(fontsize = 7, fontface = "bold"),
                        cluster_columns = T, column_title = "intrinsic apoptotic signaling pathway in response to DNA damage by p53 class mediator", column_title_gp = gpar(fontsize = 7, fontface = "bold"), 
                        column_title_side = "top", column_names_rot = 45, width = unit(13, "cm"), height = unit(7, "cm")) 

LMP.Olap_Ctrl_827_BP_obj@result
```

```{r}
browseKEGG(myKEGG_gsea_LMP_Ctrl$`LMP_923-Ctrl_923`, 'hsa05168')

```


#### KEGG gsea
```{r}
myKEGG_gsea <- lapply(my_degs_entrez_rankingScoresList, function(x){
  gseKEGG(geneList = x, organism = 'hsa', nPerm = 30000,minGSSize = 10, maxGSSize = 500, pvalueCutoff = 0.05, pAdjustMethod = "BH", verbose = TRUE)})

dotplot(myKEGG_gsea[[3]], showCategory=10, split=".sign") + facet_grid(.~.sign)+ ggtitle(paste(names(myKEGG_gsea[3]),"Gene set enrichment analysis", sep = " ")) + scale_y_discrete(label=short_label)

for (i in 1:length(myKEGG_gsea)){
  myKEGG_gsea[[i]] = setReadable(myKEGG_gsea[[i]], 'org.Hs.eg.db', 'ENTREZID')
  writeFile(myKEGG_gsea[[i]], paste0("myKEGG_gsea_",names(myKEGG_gsea[i]),".csv"))
  if (length(myKEGG_gsea[[i]]@result$ID)>0){
    dot.plot = 
      dotplot(myKEGG_gsea[[i]], showCategory=10, split=".sign") + facet_grid(.~.sign)+ 
      ggtitle(paste(names(myKEGG_gsea[i]),"KEGG GSEA", sep = " ")) + 
      scale_y_discrete(label=short_label)
      pdf(file = paste0("processedData/ORA_GSEA/", "myKEGG_gsea_", names(myKEGG_gsea[i]), ".pdf"), width = 10)
      print(dot.plot)
      dev.off()
  }
}

myKEGG_gsea_LMP_Ctrl = myKEGG_gsea[c("LMP_417-Ctrl_417","LMP_923-Ctrl_923","LMP_827-Ctrl_827","LMP_602-Ctrl_602")]
myKEGG_gsea_OLA_Ctrl = myKEGG_gsea[c("Ola_417-Ctrl_417","Ola_923-Ctrl_923","Ola_827-Ctrl_827","Ola_602-Ctrl_602")]
myKEGG_gsea_LMP.Olap_Ctrl = myKEGG_gsea[c("LMP.Olap_417-Ctrl_417","LMP.Olap_923-Ctrl_923","LMP.Olap_827-Ctrl_827","LMP.Olap_602-Ctrl_602")]
datatable(myKEGG_gsea_LMP.Olap_Ctrl[[4]]@result)
myKEGG_gsea_LMP.Olap_Ctrl[4]

LMP.Olap_Ctrl_417_KEGG = c("Apoptosis","Pathways in cancer")
LMP.Olap_Ctrl_602_KEGG = c("Nucleotide excision repair","Cell cycle", "Mismatch repair","Base excision repair")

Nucleotide_excision_repair = "hsa03420"
LMP.Olap_Ctrl_827_KEGG = c("Apoptosis","Cell cycle")
LMP.Olap_Ctrl_827_KEGG = c("hsa04210","Cell cycle")


LMP.Olap_Ctrl_827_DEGs = my_degs$`LMP.Olap_827-Ctrl_827`[-which(duplicated(my_degs$`LMP.Olap_827-Ctrl_827`$gene)),]


getFromDEGtoFC = function(contrast){
  deg = my_degs_entrez[[contrast]][-which(duplicated(my_degs_entrez[[contrast]]$ENTREZID)),]
  deg = deg[which(deg$pvalue < 0.05),]
  rownames(deg) = deg$ENTREZID
  deg = deg %>% dplyr::select(fc) %>% data.matrix()
  deg = unlist(deg[,1])
  return(deg)
}



LMP.Olap_602_Ctrl_602_pvalue = getFromDEGtoFC(contrast = 'LMP.Olap_602-Ctrl_602')
LMP.Olap_827_Ctrl_827_pvalue = getFromDEGtoFC(contrast = 'LMP.Olap_827-Ctrl_827')


my_sig_degs[['LMP.Olap_602-Ctrl_602']]
my_sig_degs_entrez$`LMP.Olap_602-Ctrl_602`

  contrast = 'LMP.Olap_602-Ctrl_602'
  my_sig_degs_entrez$`LMP.Olap_602-Ctrl_602`[-which(duplicated(my_sig_degs_entrez$`LMP.Olap_602-Ctrl_602`$ENTREZID)),]


  deg = my_sig_degs_entrez[[contrast]]
  rownames(deg) = deg$ENTREZID
  deg = deg %>% dplyr::select(fc) %>% data.matrix()
  deg = unlist(deg[,1])



LMP.Olap_Ctrl_602_geneList = my_sig_degs$`LMP.Olap_602-Ctrl_602`
LMP.Olap_Ctrl_827_geneList = my_degs$`LMP.Olap_827-Ctrl_827`


LMP.Olap_Ctrl_827_geneList$entrezid 
LMP.Olap_Ctrl_827_geneList_entrezid=bitr(LMP.Olap_Ctrl_827_geneList$ensid_gene, fromType = "ENSEMBL", toType = "ENTREZID", OrgDb="org.Hs.eg.db")
LMP.Olap_Ctrl_827_geneList_entrezid = bitr_kegg(geneID = LMP.Olap_Ctrl_827_geneList_entrezid$ENTREZID, fromType = "ncbi-geneid", toType = "kegg", organism='hsa')


datatable(my_degs_entrez$`LMP.Olap_827-Ctrl_827`[which(abs(my_degs_entrez$`LMP.Olap_827-Ctrl_827`$fc)>1),])

## convert deg entrez to gene fc
LMP.Olap_Ctrl_827_geneList = my_degs_entrez$`LMP.Olap_827-Ctrl_827`[-which(duplicated(my_degs_entrez$`LMP.Olap_827-Ctrl_827`$ENTREZID)),]
rownames(LMP.Olap_Ctrl_827_geneList) = LMP.Olap_Ctrl_827_geneList$ENTREZID
LMP.Olap_Ctrl_827_geneList = LMP.Olap_Ctrl_827_geneList %>% dplyr::select(fc) %>% data.matrix()
LMP.Olap_Ctrl_827_geneList = unlist(LMP.Olap_Ctrl_827_geneList[,1])
##

library(pathview)
Nucleotide_excision_repair = "hsa03420"
hsa04210 = pathview(gene.data = LMP.Olap_827_Ctrl_827_pvalue,pathway.id = "hsa04210",species = "hsa")
hsa03420 = pathview(gene.data = LMP.Olap_602_Ctrl_602_pvalue, pathway.id = Nucleotide_excision_repair,species = "hsa")



```

#### Reactome gsea
```{r}
myReactome_gsea <- lapply(my_degs_entrez_rankingScoresList, function(x){
  gsePathway(geneList = x, organism = 'human', nPerm = 30000, minGSSize = 10, maxGSSize = 500, pvalueCutoff = 0.05, pAdjustMethod = "BH", verbose = TRUE)})


for (i in 1:length(myReactome_gsea)){
  myReactome_gsea[[i]] = setReadable(myReactome_gsea[[i]], 'org.Hs.eg.db', 'ENTREZID')
  writeFile(myReactome_gsea[[i]], paste0("myReactome_gsea_",names(myReactome_gsea[i]),".csv"))
  if (length(myReactome_gsea[[i]]@result$ID)>0){
    dot.plot = 
      dotplot(myReactome_gsea[[i]], showCategory=10, split=".sign") + facet_grid(.~.sign)+ 
      ggtitle(paste(names(myReactome_gsea[i]),"Reactome GSEA", sep = " ")) + 
      scale_y_discrete(label=short_label)
      pdf(file = paste0("processedData/ORA_GSEA/", "myReactome_gsea_", names(myReactome_gsea[i]), ".pdf"), width = 10)
      print(dot.plot)
      dev.off()
  }
}

myReactome_gsea_LMP_Ctrl = myReactome_gsea[c("LMP_417-Ctrl_417","LMP_923-Ctrl_923","LMP_827-Ctrl_827","LMP_602-Ctrl_602")]
myReactome_gsea_OLA_Ctrl = myReactome_gsea[c("Ola_417-Ctrl_417","Ola_923-Ctrl_923","Ola_827-Ctrl_827","Ola_602-Ctrl_602")]
myReactome_gsea_LMP.Olap_Ctrl = myReactome_gsea[c("LMP.Olap_417-Ctrl_417","LMP.Olap_923-Ctrl_923","LMP.Olap_827-Ctrl_827","LMP.Olap_602-Ctrl_602")]

datatable(myReactome_gsea_LMP.Olap_Ctrl[[2]]@result)
LMP.Olap_Ctrl_827_Reactome = c("SUMOylation of DNA damage response and repair proteins", "Cell Cycle, Mitotic")
myReactome_gsea_LMP.Olap_Ctrl[3] %>% names()
```

```{r}
countNor = read.table("processedData/normalized/limma_Voom_normalized_treated-Ctrl_data.txt", header = T)
countNor_LMP_Ctrl = countNor[which(colnames(countNor)%like%c("Ctrl_%","LMP_%"))]
countNor_LMP_Ctrl$gene = gsub(".*[|]","", rownames(countNor_LMP_Ctrl))



my_sig_degs_LMP_Ctrl = my_sig_degs[which(names(my_sig_degs)%in%c("LMP_417-Ctrl_417","LMP_602-Ctrl_602","LMP_827-Ctrl_827","LMP_923-Ctrl_923"))]
my_sig_degs_Ola_Ctrl = my_sig_degs[which(names(my_sig_degs)%in%c("Ola_417-Ctrl_417","Ola_602-Ctrl_602","Ola_827-Ctrl_827","Ola_923-Ctrl_923"))]
my_sig_degs_LMP.Olap_Ctrl = my_sig_degs[which(names(my_sig_degs)%in%c("LMP.Olap_417-Ctrl_417","LMP.Olap_602-Ctrl_602","LMP.Olap_827-Ctrl_827","LMP.Olap_923-Ctrl_923"))]
my_sig_degs_LMP.Olap_Ola = my_sig_degs[which(names(my_sig_degs)%in%c("LMP.Olap_417-Ola_417","LMP.Olap_602-Ola_602","LMP.Olap_827-Ola_827","LMP.Olap_923-Ola_923"))]
my_sig_degs_LMP.Olap_LMP = my_sig_degs[which(names(my_sig_degs)%in%c("LMP.Olap_417-LMP_417","LMP.Olap_602-LMP_602","LMP.Olap_827-LMP_827","LMP.Olap_923-LMP_923"))]




# my_sig_degs_LMP_Ctrl_genes = Reduce(union, list(my_sig_degs_LMP_Ctrl[[1]]$gene,my_sig_degs_LMP_Ctrl[[2]]$gene,
#                                                 my_sig_degs_LMP_Ctrl[[3]]$gene,my_sig_degs_LMP_Ctrl[[4]]$gene))

myHeatmap = function(df.list,cell1, cell2){
  countNor_select = countNor[which(colnames(countNor)%like%c(cell1,cell2))]
  countNor_select$gene = gsub(".*[|]","", rownames(countNor_select))
  genes = list()
  count_nor = list()
  for (i in 1:length(df.list)){
    genes[[i]] = df.list[[i]]$gene
    count_nor[[i]] = countNor_select[which(countNor_select$gene%in%genes[[i]]),]
    count_nor[[i]] = count_nor[[i]][!duplicated(count_nor[[i]]$gene),]
    rownames(count_nor[[i]]) = count_nor[[i]]$gene
    count_nor[[i]]$gene = NULL
    if (nrow(count_nor[[i]])>0){
      heatmap.plot = 
      ComplexHeatmap::Heatmap(matrix = t(scale(t(data.matrix(count_nor[[i]])))), name="Z-score", km=1, 
                        col=colorRampPalette(rev(brewer.pal(n = 7, name ="RdYlBu")))(100), 
                        row_names_gp = gpar(fontsize = ifelse(nrow(data) <= 30, 10,  
                                                              ifelse(30<nrow(data)&nrow(data) <= 45, 7,  
                                                                     ifelse(45<nrow(data)&nrow(data) <= 60, 5, 4))), 
                        fontface = "bold"),column_names_gp = gpar(fontsize = 8, fontface = "bold"),
                        cluster_columns = T, column_title = paste(names(df.list[i])), 
                        column_title_gp = gpar(fontsize = 13, fontface = "bold"), column_title_side = "top", column_names_rot = 80)
      pdf(paste0("results/", "heatmap_", names(df.list[i]),".pdf"))
      print(heatmap.plot)
      dev.off()
    }   
  }
}

myHeatmap(df.list = my_sig_degs_LMP_Ctrl, cell1="Ctrl_%", cell2 = "LMP_%")
myHeatmap(df.list = my_sig_degs_Ola_Ctrl, cell1="Ctrl_%", cell2 = "Ola_%")
myHeatmap(df.list = my_sig_degs_LMP.Olap_Ctrl, cell1="Ctrl_%", cell2 = "LMP.Olap_%")
myHeatmap(df.list = my_sig_degs_LMP.Olap_Ola, cell1="Ola_%", cell2 = "LMP.Olap_%")
myHeatmap(df.list = my_sig_degs_LMP.Olap_LMP, cell1="LMP_%", cell2 = "LMP.Olap_%")



genes = list()
count_nor = list()
for (i in 1:4){
  genes[[i]] = my_sig_degs_LMP_Ctrl[[i]]$gene
   count_nor[[i]] = countNor_LMP_Ctrl[which(countNor_LMP_Ctrl$gene%in%genes[[i]]),]
   rownames(count_nor[[i]]) = count_nor[[i]]$gene
    count_nor[[i]]$gene = NULL
   if (nrow(count_nor[[i]])>0){
    heatmap.plot = 
    ComplexHeatmap::Heatmap(matrix = t(scale(t(data.matrix(count_nor[[i]])))), name="Z-score", km=1, 
                        col=colorRampPalette(rev(brewer.pal(n = 7, name ="RdYlBu")))(100), 
                        row_names_gp = gpar(fontsize = ifelse(nrow(data) <= 30, 10,  
                                                              ifelse(30<nrow(data)&nrow(data) <= 45, 7,  
                                                                     ifelse(45<nrow(data)&nrow(data) <= 60, 5, 4))), 
                        fontface = "bold"),column_names_gp = gpar(fontsize = 10, fontface = "bold"),
                        cluster_columns = T, column_title = paste(names(my_sig_degs_LMP_Ctrl[i])), 
                        column_title_gp = gpar(fontsize = 13, fontface = "bold"), column_title_side = "top", column_names_rot = 60)
      pdf(paste0("results/", "heatmap_", names(my_sig_degs_LMP_Ctrl[i]),".pdf"))
      print(heatmap.plot)
      dev.off()
   }   
}





countNor_LMP_Ctrl_select = countNor_LMP_Ctrl[which(countNor_LMP_Ctrl$gene%in%my_sig_degs_LMP_Ctrl_genes),]
rownames(countNor_LMP_Ctrl_select) = countNor_LMP_Ctrl_select$gene
countNor_LMP_Ctrl_select$gene=NULL

mypalette <- brewer.pal(11,"RdYlBu")
morecols <- colorRampPalette(mypalette)

data = countNor_LMP_Ctrl_select

ComplexHeatmap::Heatmap(matrix = t(scale(t(data.matrix(data)))), name="Z-score", km=1, 
                        col=colorRampPalette(rev(brewer.pal(n = 7, name ="RdYlBu")))(100), 
                        row_names_gp = gpar(fontsize = ifelse(nrow(data) <= 30, 10,  
                                                              ifelse(30<nrow(data)&nrow(data) <= 45, 7,  
                                                                     ifelse(45<nrow(data)&nrow(data) <= 60, 5, 4))), 
                        fontface = "bold"),column_names_gp = gpar(fontsize = 10, fontface = "bold"),
                        cluster_columns = T, column_title = "countNor_LMP_Ctrl_select", 
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"), column_title_side = "top", column_names_rot = 60)
```

```{r}
my_sig_degs_LMP_Ctrl = my_sig_degs[which(names(my_sig_degs)%in%c("LMP_417-Ctrl_417","LMP_602-Ctrl_602","LMP_827-Ctrl_827","LMP_923-Ctrl_923"))]
my_sig_degs_Ola_Ctrl = my_sig_degs[which(names(my_sig_degs)%in%c("Ola_417-Ctrl_417","Ola_602-Ctrl_602","Ola_827-Ctrl_827","Ola_923-Ctrl_923"))]
my_sig_degs_LMP.Olap_Ctrl = my_sig_degs[which(names(my_sig_degs)%in%c("LMP.Olap_417-Ctrl_417","LMP.Olap_602-Ctrl_602","LMP.Olap_827-Ctrl_827","LMP.Olap_923-Ctrl_923"))]
my_sig_degs_LMP.Olap_Ola = my_sig_degs[which(names(my_sig_degs)%in%c("LMP.Olap_417-Ola_417","LMP.Olap_602-Ola_602","LMP.Olap_827-Ola_827","LMP.Olap_923-Ola_923"))]
my_sig_degs_LMP.Olap_LMP = my_sig_degs[which(names(my_sig_degs)%in%c("LMP.Olap_417-LMP_417","LMP.Olap_602-LMP_602","LMP.Olap_827-LMP_827","LMP.Olap_923-LMP_923"))]

myVenn = function(sigDeg, name){
venn.plot <- venn.diagram(list(sigDeg[[1]]$gene,
                                     sigDeg[[2]]$gene,
                                     sigDeg[[3]]$gene,
                                     sigDeg[[4]]$gene), NULL, 
                                fill=c("blue", "red","grey","green"), lwd = 1, cat.cex = 2,
                                alpha=c(0.5,0.5,0.5,0.5), cex = 3, cat.fontface=4, 
                                category.names=c(paste(names(sigDeg[1])),
                                                 paste(names(sigDeg[2])),
                                                 paste(names(sigDeg[3])),
                                                 paste(names(sigDeg[4]))))

pdf(file = paste0("results/", name), width = 22, height = 14)
grid.draw(venn.plot)
dev.off()
}

myVenn(sigDeg = my_sig_degs_LMP_Ctrl, name = "venn_LMP-Ctrl.pdf")
myVenn(sigDeg = my_sig_degs_Ola_Ctrl, name = "venn_Ola-Ctrl.pdf")
myVenn(sigDeg = my_sig_degs_LMP.Olap_Ctrl, name = "venn_LMP.Olap-Ctrl.pdf")
myVenn(sigDeg = my_sig_degs_LMP.Olap_Ola, name = "venn_LMP.Olap-Ola.pdf")
myVenn(sigDeg = my_sig_degs_LMP.Olap_LMP, name = "venn_LMP.Olap-LMP.pdf")

```


```{r}
dir.create("processedData/IPA")
names(my_degs)
my_degs_602 = my_degs[which(names(my_degs)%like%"%602%")]

common.ensid.602 = Reduce(intersect, list(my_degs_602[[1]]$ensid_gene,my_degs_602[[2]]$ensid_gene,
                                          my_degs_602[[3]]$ensid_gene,my_degs_602[[4]]$ensid_gene,
                                          my_degs_602[[5]]$ensid_gene,my_degs_602[[6]]$ensid_gene)) 

for (i in 1:length(my_degs_602)){
  my_degs_602[[i]] = my_degs_602[[i]][which(my_degs_602[[i]]$ensid_gene%in%common.ensid.602),]
  my_degs_602[[i]] = my_degs_602[[i]][,c("ensid_gene","gene","log2fc","pvalue")]
  colnames(my_degs_602[[i]]) = paste0(colnames(my_degs_602[[i]]), "_",names(my_degs_602[i]))
}

my_degs_602_IPA = cbind(my_degs_602[[1]],my_degs_602[[2]],my_degs_602[[3]],my_degs_602[[4]],my_degs_602[[5]],my_degs_602[[6]])
my_degs_602_IPA$ensemble=my_degs_602_IPA[,1]
my_degs_602_IPA$symbol=my_degs_602_IPA[,2]

my_degs_602_IPA$ensemble = my_degs_602_IPA$`ensid_gene_LMP_602-Ctrl_602`
my_degs_602_IPA$symbol = my_degs_602_IPA$`gene_LMP_602-Ctrl_602`
my_degs_602_IPA = my_degs_602_IPA[,-which(colnames(my_degs_602_IPA)%like%c("%ensid%", "%gene%"))]
my_degs_602_IPA = my_degs_602_IPA[,c(13,14,1,2,3,4,5,6,7,8,9,10,11,12)]
write.table(my_degs_602_IPA, "processedData/IPA/my_degs_602_IPA.txt", quote = F, row.names = F, sep = "\t")


my_degs_417 = my_degs[which(names(my_degs)%like%"%417%")]
my_degs_923 = my_degs[which(names(my_degs)%like%"%923%")]
my_degs_827 = my_degs[which(names(my_degs)%like%"%827%")]

myDEGsForIPA = function(mydegs){
  common.ensid.602 = Reduce(intersect, list(mydegs[[1]]$ensid_gene,mydegs[[2]]$ensid_gene,
                                          mydegs[[3]]$ensid_gene,mydegs[[4]]$ensid_gene,
                                          mydegs[[5]]$ensid_gene,mydegs[[6]]$ensid_gene)) 

for (i in 1:length(mydegs)){
  mydegs[[i]] = mydegs[[i]][which(mydegs[[i]]$ensid_gene%in%common.ensid.602),]
  mydegs[[i]] = mydegs[[i]][,c("ensid_gene","gene","log2fc","pvalue")]
  colnames(mydegs[[i]]) = paste0(colnames(mydegs[[i]]), "_",names(mydegs[i]))
}

mydegs_IPA = cbind(mydegs[[1]],mydegs[[2]],mydegs[[3]],mydegs[[4]],mydegs[[5]],mydegs[[6]])
mydegs_IPA$ensemble=mydegs_IPA[,1]
mydegs_IPA$symbol=mydegs_IPA[,2]

mydegs_IPA$ensemble = mydegs_IPA[,1]
mydegs_IPA$symbol = mydegs_IPA[,2]
mydegs_IPA = mydegs_IPA[,-which(colnames(mydegs_IPA)%like%c("%ensid%", "%gene%"))]

}

my_degs_417_IPA = myDEGsForIPA(mydegs = my_degs_417)
my_degs_417_IPA = my_degs_417_IPA[,c(13,14,1,2,3,4,5,6,7,8,9,10,11,12)]
write.table(my_degs_417_IPA, "processedData/IPA/my_degs_417_IPA.txt", quote = F, row.names = F, sep = "\t")

my_degs_923_IPA = myDEGsForIPA(mydegs = my_degs_923)
my_degs_923_IPA = my_degs_923_IPA[,c(13,14,1,2,3,4,5,6,7,8,9,10,11,12)]
write.table(my_degs_923_IPA, "processedData/IPA/my_degs_923_IPA.txt", quote = F, row.names = F, sep = "\t")

my_degs_827_IPA = myDEGsForIPA(mydegs = my_degs_827)
my_degs_827_IPA = my_degs_827_IPA[,c(13,14,1,2,3,4,5,6,7,8,9,10,11,12)]
write.table(my_degs_827_IPA, "processedData/IPA/my_degs_827_IPA.txt", quote = F, row.names = F, sep = "\t")


```

```{r}
save.image(file = "ccbr1032.RData")
```

